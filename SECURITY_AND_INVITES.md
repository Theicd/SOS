# שיפור אבטחה ומנגנון הזמנות (SOS)

## 1. שיפור אבטחה על בסיס התשתית הקיימת

### נקודות חשופות כיום
- צ׳אט טקסט: נשלח גלוי לריליי (ללא הצפנת קצה-לקצה).
- מפתח פרטי: נשמר ב-localStorage ללא הצפנת אחסון (חשוף ל-XSS/מחשב פרוץ).
- מטא-דאטה: מי מדבר עם מי ואילו ריליי בשימוש גלויים.
- איתותי P2P: מוצפנים רק אם App.encryptMessage קיים; אחרת גלוי.
- שיחות קול/וידאו: WebRTC מוצפן, אך שרתי תווך ציבוריים (TURN) הם צוואר בקבוק/נקודת אמון.
- מודרציה: אין שכבת חסימה/סינון בצד לקוח למפתחות בעייתיים/ספאם.
- אחסון מדיה: אין הבטחת שימור לקבצים כבדים; תלוי בריליי/עמיתים.
- מחיקה: kind 5 היא בקשה בלבד, לא מחיקה מובטחת.

### שיפורים ממוקדים (ללא ספריות חדשות)
1. **הצפנת צ׳אט בטקסט (nip04):**
   - שליחה: לפני finalizeEvent להצפין עם `NostrTools.nip04.encrypt(App.privateKey, peerPubkey, text)`, להוסיף תג `['enc','nip04']`.
   - קבלה: אם יש תג/תוכן מוצפן – לפענח עם `nip04.decrypt` ולשבץ את הטקסט המפוענח.
2. **הצפנת המפתח הפרטי באחסון:**
   - לעטוף את `nostr_private_key` ב-AES-GCM עם סיסמה שהמשתמש בוחר לפני שמירה ב-localStorage.
   - בעת הפעלה: לבקש סיסמה, לפענח ולהטעין את המפתח.
3. **הצפנת איתותי P2P כברירת מחדל:**
   - ב-p2p-video-sharing להפוך encrypt/decrypt לחובה; אם אין, לא לשלוח גלוי אלא להתריע.
4. **ניהול ריליי:**
   - UI לניהול/בדיקת תקינות (פינג), הוספה/הסרה מהירה, חיווי ריליי בעייתיים.
5. **חסימות/סינון בצד לקוח:**
   - רשימת חסומים (pubkeys) ב-localStorage; דילוג על הודעות/פוסטים ממשתמש חסום.
6. **אזהרת מחיקה:**
   - בעת מחיקה להציג למשתמש שהמחיקה היא best-effort בלבד ברשת נוסטר.
7. **שרת תווך לשיחות:**
   - לאפשר הגדרת שרת TURN פרטי במקום ציבורי כדי לשפר אמינות/פרטיות.
8. **אחסון מדיה:**
   - לאפשר יעד הצמדה/שימור (למשל בלוסום/שירות הצמדה) או להתריע למשתמש שקבצים גדולים לא מובטחים ללא הצמדה.

## 2. מנגנון פתיחת משתמשים חדשים והזמנות (כולל וואטסאפ)

### בעיות אם שולחים מפתח גלוי
- כל מי שרואה את ההודעה יכול לגנוב את הזהות לפני בעל הטלפון.
- הקלדת מספר טלפון ללא אימות אינה הוכחת בעלות.
- הזמנה ללא תוקף/שימוש חד-פעמי חשופה לשימוש חוזר/העברה.

### זרימת הזמנה מומלצת (בלי שרת חדש)
1. **יצירת הזמנה חתומה וחד-פעמית:**
   - ליצור מזהה חד-פעמי (nonce) + חותמת זמן + תוקף קצר.
   - לחתום עם המפתח של המזמין (nostr-tools). ניתן לפרסם אירוע “הזמנה” ולסמן כמנוצל בעת שימוש.
2. **קישור/קוד הזמנה:**
   - לייצר קישור שמכיל את המזהה החתום + תוקף. לא לשלוח מפתח גולמי.
3. **הפצה דרך וואטסאפ עם חיכוך מינימלי:**
   - כפתור “הזמן משתמש” פותח דיאלוג טלפון.
   - לחיצה על “אישור” יוצרת הזמנה (חתימה + תוקף), מעתיקה ללוח, ופותחת `wa.me/<phone>?text=<invite>`.
4. **שימוש חד-פעמי/מניעת ריפליי:**
   - כאשר המוזמן פותח את הקישור, לסמן את ההזמנה כמנוצלת (אירוע חתום או סטייט מקומי) כדי למנוע שימוש חוזר.
5. **הצגת זהות המזמין:**
   - בקישור להזמנה לכלול את pubkey החתום של המזמין כדי שהמוזמן יוכל לזהות מי הזמין.
6. **טלפון (אופציונלי):**
   - בלי שרת SMS אין הוכחת בעלות; אפשר לבקש טלפון להצגה/זיהוי בלבד, לא כגורם אימות.

### מה זה משפר ומה לא
- **חוויית משתמש:** פחות שלבים ידניים; וואטסאפ נפתח עם טקסט מוכן.
- **אבטחה:** חיכוך טוב יותר (תוקף קצר, חד-פעמי, חתימה). אך לא הרמטי: ההודעה בוואטסאפ עדיין ניתנת להעברה; מספר טלפון ללא אימות אינו הוכחה.

### מינימום צעדים ליישום
- פונקציה ליצירת הזמנה: nonce + תוקף + חתימה (nostr-tools), הפקה לקישור.
- פונקציה לפתיחת דיאלוג טלפון → העתקה ללוח → פתיחת wa.me עם הטקסט.
- פונקציה לאימות קישור: בדיקת חתימה, תוקף, וסימון “שומש” (באירוע או בסטייט).
- הצפנת צ׳אט ועטיפת מפתח פרטי (כאמור בסעיף 1) כדי שלא ייחשף במקרה של הדלפת קישור.
