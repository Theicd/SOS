<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>האחסון שלי – SOS2</title>
    <link rel="icon" type="image/png" href="./icons/WAPICON.png" />
    <link rel="stylesheet" href="./storage/storage.css" />
    <!-- חלק עיצובים משותפים לתפריטים (storage.html) – שומר מראה זהה לפיד | HYPER CORE TECH -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./styles/facebook-theme.css">
    <link rel="stylesheet" href="./styles/media-overrides.css">
    <!-- חלק עיצובים ללוגו ולצ'אט (storage.html) – כדי לשמור על מראה ותפקוד זהים לפיד | HYPER CORE TECH -->
    <link rel="stylesheet" href="./styles/logo.css">
    <link rel="stylesheet" href="./styles/chat.css">
    <link rel="stylesheet" href="./styles/chat-whatsapp-theme.css">
    <link rel="stylesheet" href="./styles/chat-file-transfer.css">
    <link rel="stylesheet" href="./styles/chat-dialog.css">
    <link rel="stylesheet" href="./styles/chat-voice-call.css">
    <link rel="stylesheet" href="./styles/chat-video-call.css">
    <!-- חלק עיצובים ללוח גידול וחוזה חכם (storage.html) – כדי שהחלונות יוצגו נכון | HYPER CORE TECH -->
    <link rel="stylesheet" href="./styles/market-dashboard.css">
    <link rel="stylesheet" href="./styles/contract-dashboard-v2.css">
  </head>
  <body class="storage-body">
    <div class="storage-backdrop" aria-hidden="true"></div>
    <!-- חלק תפריט עליון זהה (storage.html) – מועתק מ-index ללא שינוי לוגיקה | HYPER CORE TECH -->
    <header class="top-bar">
      <div class="app-logo">
        <div class="sos-logo">
          <span class="sos-char sos-s">S</span>
          <span class="sos-char sos-o">O</span>
          <span class="sos-char sos-s">S</span>
        </div>
        <div class="sos-tagline">רשת קריפטונית מבוזרת</div>
      </div>
      <div class="top-bar__actions">
        <!-- חלק ניווט חדשות (storage.html) – אייקון חדשות בסרגל העליון לפתיחת דף החדשות | HYPER CORE TECH -->
        <button class="circle-button" id="newsToggleTop" aria-label="חדשות">
          <i class="fa-solid fa-newspaper"></i>
        </button>
        <button class="circle-button" id="datingToggleTop" aria-label="הכרויות">
          <i class="fa-solid fa-heart"></i>
        </button>
        <button class="circle-button" id="gamesToggleTop" aria-label="משחקים">
          <i class="fa-solid fa-gamepad"></i>
        </button>
        <button class="circle-button" id="notificationsToggle" aria-label="התראות">
          <i class="fa-solid fa-bell"></i>
          <span class="notifications-badge" id="notificationsBadge" hidden></span>
        </button>
        <button class="circle-button" id="messagesToggle" aria-label="הודעות">
          <i class="fa-solid fa-message"></i>
          <span class="notifications-badge" id="messagesBadge" hidden></span>
        </button>
        <div class="top-bar__profile" id="topBarProfile">
          <button class="top-bar__avatar" id="topBarProfileButton" aria-haspopup="true" aria-expanded="false" aria-label="פרופיל משתמש">
            <span id="topBarProfileAvatar">?</span>
          </button>
          <div class="top-bar__dropdown" id="topBarProfileMenu" hidden>
            <button type="button" class="top-bar__dropdown-item" id="topBarProfileGrowth">
              <i class="fa-solid fa-chart-line"></i>
              <span>לוח גידול הרשת</span>
            </button>
            <button type="button" class="top-bar__dropdown-item" id="topBarProfileSelf">
              <i class="fa-solid fa-id-card"></i>
              <span>הפרופיל שלי</span>
            </button>
            <button type="button" class="top-bar__dropdown-item" id="topBarProfileKey">
              <i class="fa-solid fa-key"></i>
              <span>הצגת מפתח</span>
            </button>
            <button type="button" class="top-bar__dropdown-item" id="topBarProfileContract">
              <i class="fa-solid fa-handshake"></i>
              <span>חוזה חכם</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- חלק תפריט תחתון זהה (storage.html) – מועתק מ-index | HYPER CORE TECH -->
    <nav class="primary-nav" aria-label="ניווט ראשי">
      <button class="nav-item" data-nav="home">
        <i class="fa-solid fa-house"></i>
        <span>בית</span>
      </button>
      <button class="nav-item" data-nav="videos">
        <i class="fa-solid fa-clapperboard"></i>
        <span>וידאו פיד</span>
      </button>
      <button class="nav-item" id="navCompose" type="button" aria-label="פוסט חדש" onclick="openCompose()">
        <i class="fa-solid fa-plus"></i>
        <span>פוסט חדש</span>
      </button>
      <button class="nav-item" type="button" aria-label="הפרופיל שלי" onclick="window.location.href='./profile.html'">
        <i class="fa-solid fa-id-card"></i>
        <span>הפרופיל שלי</span>
      </button>
      <button class="nav-item is-active" data-nav="storage">
        <i class="fa-solid fa-box-archive"></i>
        <span>האחסון שלי</span>
      </button>
    </nav>

    <!-- חלק התראות (storage.html) – אותו פאנל כמו בפיד | HYPER CORE TECH -->
    <div class="notifications-panel" id="notificationsPanel" hidden>
      <header class="notifications-panel__header">
        <h2>התראות</h2>
        <button type="button" class="notifications-panel__mark" id="notificationsMarkRead">סמן כנקראו</button>
      </header>
      <div class="notifications-panel__body">
        <p class="notifications-panel__empty" id="notificationsEmpty">אין התרעות חדשות כרגע.</p>
        <ul class="notifications-panel__list" id="notificationsList"></ul>
      </div>
    </div>

    <!-- חלק צ'אט (storage.html) – אותו מבנה כמו בפיד כדי שכפתור ההודעות יעבוד | HYPER CORE TECH -->
    <section class="chat-panel" id="chatPanel" hidden aria-label="מסנג'ר פרטי">
      <div class="chat-panel__body">
        <aside class="chat-contacts" aria-label="רשימת שיחות">
          <div class="chat-contacts__search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="search" id="chatSearchInput" placeholder="חיפוש בצ'אט" autocomplete="off">
            <div class="chat-contacts__actions" role="group" aria-label="פעולות מהירות בצ'אט">
              <button type="button" class="chat-panel__icon" aria-label="תפריט הצ'אט">
                <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>
              <button type="button" class="chat-panel__icon" id="chatCloseButton" aria-label="סגירת הצ'אט">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>
          <div class="chat-contacts__filters">
            <button type="button" class="chat-filter-chip is-active" data-chat-filter="all">הכל</button>
            <button type="button" class="chat-filter-chip" data-chat-filter="unread">לא נקראו</button>
          </div>
          <div class="chat-contacts__list" id="chatContactsList"></div>
        </aside>
        <main class="chat-conversation" aria-live="polite">
          <section class="chat-notifications" id="chatNotifications" hidden>
            <header class="chat-notifications__header">
              <div class="chat-notifications__title">
                <i class="fa-solid fa-bell"></i>
                <div>
                  <h2>התראות</h2>
                  <p>לייקים ותגובות אחרונים לפוסטים שלך</p>
                </div>
              </div>
              <button type="button" class="chat-notifications__mark" id="chatNotificationsMarkRead">סמן כנקראו</button>
            </header>
            <div class="chat-notifications__body">
              <p class="chat-notifications__empty" id="chatNotificationsEmpty">אין התרעות חדשות כרגע.</p>
              <ul class="chat-notifications__list" id="chatNotificationsList"></ul>
            </div>
          </section>
          <div class="chat-conversation__empty" id="chatEmptyState">
            <i class="fa-regular fa-comments"></i>
            <p>בחר איש קשר כדי להתחיל לשוחח.</p>
          </div>
          <header class="chat-conversation__header" id="chatConversationHeader" hidden>
            <button type="button" class="chat-conversation__back" id="chatConversationBack" aria-label="חזרה לרשימת שיחות">
              <i class="fa-solid fa-arrow-right"></i>
            </button>
            <div class="chat-conversation__avatar" id="chatConversationAvatar">?</div>
            <div class="chat-conversation__meta">
              <span class="chat-conversation__name" id="chatConversationName">שותף לשיחה</span>
              <span class="chat-conversation__status" id="chatConversationStatus">מחובר</span>
            </div>
            <div class="chat-conversation__actions">
              <button type="button" class="chat-conversation__icon" aria-label="שיחת קול">
                <i class="fa-solid fa-phone"></i>
              </button>
              <button type="button" class="chat-conversation__icon chat-conversation__icon--back" id="chatConversationActionsBack" aria-label="חזרה לרשימת שיחות">
                <i class="fa-solid fa-arrow-right-long"></i>
              </button>
            </div>
          </header>
          <div class="chat-conversation__messages" id="chatMessages"></div>
          <form class="chat-composer" id="chatComposer" hidden>
            <div class="chat-composer__field">
              <button type="button" class="chat-composer__icon chat-composer__icon--file" id="chatComposerFileButton" aria-label="צרף קובץ">
                <i class="fa-solid fa-paperclip"></i>
              </button>
              <textarea id="chatMessageInput" placeholder="כתוב הודעה..." rows="1"></textarea>
              <button type="submit" class="chat-composer__icon chat-composer__send" aria-label="שלח הודעה">
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </div>
            <div class="chat-composer__file-preview" id="chatComposerFilePreview" hidden>
              <span class="chat-composer__file-name" id="chatComposerFileName">שם קובץ</span>
              <button type="button" class="chat-composer__file-remove" id="chatComposerFileRemove" aria-label="הסר קובץ">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <input type="file" id="chatComposerFileInput" hidden>
          </form>
        </main>
      </div>
      <nav class="chat-panel__footer" id="chatPanelFooter" aria-label="ניווט צ'אט">
        <button type="button" class="chat-footer__item is-active" data-chat-nav="contacts">
          <i class="fa-solid fa-comments"></i>
          <span>שיחות</span>
        </button>
        <button type="button" class="chat-footer__item" data-chat-nav="notifications">
          <i class="fa-solid fa-bell"></i>
          <span>התראות</span>
          <span class="chat-footer__badge" id="chatFooterNotificationsBadge" hidden>0</span>
        </button>
        <button type="button" class="chat-footer__item" data-chat-nav="home">
          <i class="fa-solid fa-house"></i>
          <span>דף הבית</span>
        </button>
      </nav>
    </section>

    <!-- כותרת פנימית של דף האחסון נשמרת | HYPER CORE TECH -->
    <header class="storage-topbar">
      <div class="storage-brand">
        <img src="./storage/logo.svg" alt="לוגו אחסון" class="storage-brand__logo" />
        <div class="storage-brand__titles">
          <span class="storage-brand__name">האחסון שלי</span>
          <span class="storage-brand__tag">לינקים מיידיים לתוכן שלכם</span>
        </div>
      </div>
      <nav class="storage-menu" aria-label="מידע נוסף">
        <!-- חלק אחסון (storage.html) – כפתור הסבר הפעלה | HYPER CORE TECH -->
        <button type="button" class="storage-menu__button" data-modal-target="howModal">איך זה עובד?</button>
        <!-- חלק אחסון (storage.html) – כפתור שאלות נפוצות | HYPER CORE TECH -->
        <button type="button" class="storage-menu__button" data-modal-target="faqModal">שאלות</button>
      </nav>
      <div class="storage-availability" id="availabilityStatus" aria-live="polite">בודק זמינות...</div>
    </header>

    <main class="storage-main">
      <section class="storage-hero" aria-label="הצגת השירות">
        <h1 class="storage-hero__title">גררו מדיה וקבלו קישור מיידי</h1>
        <p class="storage-hero__subtitle">
          העלו סרטון, תמונה או הקלטה – אנחנו נדחוס אם צריך ונחזיר קישור קל לשיתוף בכל מקום.
        </p>
      </section>

      <section class="storage-drop" aria-label="אזור הגרירה וההעלאה">
        <div class="storage-drop__panel" id="dropZone">
          <input type="file" id="fileInput" accept="video/*,audio/*,image/*" hidden />
          <div class="storage-drop__icon" aria-hidden="true">⬆</div>
          <p class="storage-drop__title">גררו לכאן קובץ בודד</p>
          <p class="storage-drop__hint">MP4 · MOV · MP3 · WAV · JPG · PNG ועוד</p>
          <ul class="storage-drop__list">
            <li>דחיסת וידאו אוטומטית עד ‎30MB‎</li>
            <li>קישור ציבורי מיידי</li>
            <li>שיתוף בחינם לכל החברים</li>
          </ul>
          <button type="button" class="storage-drop__button" id="selectButton">בחרו קובץ</button>
        </div>
        <div class="storage-drop__status" id="statusBox" aria-live="assertive">
          <span id="statusMessage">ממתין לקובץ...</span>
          <progress id="progressBar" class="storage-drop__progress" hidden></progress>
          <span id="progressValue" hidden>0%</span>
        </div>
      </section>

      <section class="storage-result" id="resultPanel" hidden aria-live="polite">
        <h2 class="storage-result__title">הקישור שלכם מוכן</h2>
        <div class="storage-result__preview" id="resultPreview"></div>
        <button type="button" class="storage-result__copy" id="copyButton">העתיקו קישור</button>
      </section>
    </main>

    <footer class="storage-footer">
      <div class="storage-footer__primary">
        <span>© האחסון שלי – SOS2</span>
        <span>שירות קהילה ללא עלות</span>
      </div>
      <nav class="storage-footer__links" aria-label="קישורים משלימים">
        <a class="storage-footer__link" href="https://void.cat/" target="_blank" rel="noreferrer">שרת ההעלאות</a>
        <a class="storage-footer__link" href="https://nostr.com/" target="_blank" rel="noreferrer">לקריאה על Nostr</a>
      </nav>
    </footer>

    <!-- חלק אחסון (storage.html) – מודאל הסבר שימוש | HYPER CORE TECH -->
    <section class="storage-modal" id="howModal" hidden aria-hidden="true">
      <div class="storage-modal__backdrop" data-modal-close="howModal"></div>
      <div class="storage-modal__content" role="dialog" aria-modal="true" aria-labelledby="howTitle">
        <button type="button" class="storage-modal__close" data-modal-close="howModal">×</button>
        <h2 id="howTitle">איך משתמשים?</h2>
        <ol>
          <li>בחרו או גררו קובץ בודד (וידאו עד ‎30MB‎).</li>
          <li>המתינו לדחיסה ולהעלאה.</li>
          <li>קבלו קישור להעתקה ושיתוף.</li>
        </ol>
      </div>
    </section>

    <!-- חלק אחסון (storage.html) – מודאל שאלות נפוצות | HYPER CORE TECH -->
    <section class="storage-modal" id="faqModal" hidden aria-hidden="true">
      <div class="storage-modal__backdrop" data-modal-close="faqModal"></div>
      <div class="storage-modal__content" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
        <button type="button" class="storage-modal__close" data-modal-close="faqModal">×</button>
        <h2 id="faqTitle">שאלות נפוצות</h2>
        <details>
          <summary>כמה זמן הקובץ נשמר?</summary>
          <p>ברירת המחדל היא לפחות שבעה ימים, לרוב יותר. מומלץ לשמור גיבוי אישי.</p>
        </details>
        <details>
          <summary>האם השירות בתשלום?</summary>
          <p>לא. אנחנו מציעים שיתוף חינמי לעידוד הצטרפות לרשת.</p>
        </details>
        <details>
          <summary>האם ניתן למחוק קובץ?</summary>
          <p>שימרו את הקישור שנוצר – שם תמצאו אפשרות דיווח למחיקה מהשרת.</p>
        </details>
      </div>
    </section>

    <!-- חלק מודל מפתח (storage.html) – חלון הצגת מפתח פרטי כמו בפיד | HYPER CORE TECH -->
    <div class="modal" id="keyModal">
        <div class="modal-content key-modal">
            <h2>המפתח הפרטי שלך</h2>
            <textarea id="keyViewerTextarea" readonly></textarea>
            <div class="modal-actions">
                <button class="icon-button" onclick="copyKeyViewer()">העתק</button>
                <button class="button-secondary" onclick="closeKeyViewer()">סגור</button>
            </div>
            <div class="modal-actions">
                <button class="button-secondary" onclick="logoutAndSwitchUser()">התנתק והחלף משתמש</button>
            </div>
            <div class="p2p-status" id="keyViewerStatus"></div>
        </div>
    </div>

    <!-- חלק חוזה חכם (storage.html) – חלון אימות סיסמה לפני פתיחת החוזה | HYPER CORE TECH -->
    <div class="modal contract-password-modal" id="contractPasswordModal" aria-hidden="true" hidden>
        <div class="modal-content contract-password-modal__content" role="dialog" aria-modal="true" aria-labelledby="contractPasswordTitle">
            <h2 id="contractPasswordTitle">גישה לחוזה החכם</h2>
            <p>כדי להמשיך אל מודול החוזה החכם יש להזין את קוד הגישה שנמסר לך.</p>
            <label class="contract-password-modal__label" for="contractPasswordInput">קוד גישה</label>
            <input type="password" id="contractPasswordInput" class="contract-password-modal__input" placeholder="הקלד/י את הסיסמה" autocomplete="off" />
            <div class="contract-password-modal__error" id="contractPasswordError" role="alert" hidden>סיסמה שגויה. נסו שוב.</div>
            <div class="modal-actions">
                <button class="button-secondary" type="button" id="contractPasswordCancel">ביטול</button>
                <button class="button-primary" type="button" id="contractPasswordSubmit">אישור</button>
            </div>
        </div>
    </div>

    <!-- חלק לוח גידול (storage.html) – לוח מדד גידול הרשת כמו בפיד | HYPER CORE TECH -->
    <section class="growth-dashboard" id="growthDashboard" aria-hidden="true">
        <div class="growth-dashboard__backdrop" onclick="closeGrowthDashboard()"></div>
        <article class="growth-dashboard__panel" role="dialog" aria-modal="true">
            <header class="growth-dashboard__header">
                <div class="growth-dashboard__title">
                    <i class="fa-solid fa-chart-line"></i>
                    <div>
                        <h2>מדד גידול הרשת</h2>
                        <p>מעקב בזמן אמת אחרי בריאות האקו-סיסטם</p>
                    </div>
                </div>
                <button class="growth-dashboard__close" type="button" onclick="console.log('[STORAGE] Close button clicked'); closeGrowthDashboard();" aria-label="סגירת לוח הגידול">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </header>
            <nav class="growth-dashboard__tabs" role="tablist">
                <button class="growth-dashboard__tab is-active" data-tab="overview" role="tab">סקירה</button>
                <button class="growth-dashboard__tab" data-tab="activity" role="tab">פעילות זמן אמת</button>
                <button class="growth-dashboard__tab" data-tab="leaders" role="tab">מובילי רשת</button>
            </nav>
            <div class="growth-dashboard__content">
                <section class="growth-dashboard__section" data-pane="overview">
                    <div class="growth-metrics" id="growthMetrics"></div>
                    <div class="growth-chart" id="growthChartContainer">
                        <div class="growth-chart__ranges" role="group" aria-label="טווח היסטוריה">
                            <button type="button" class="growth-chart__range-button" data-range="1d">יום</button>
                            <button type="button" class="growth-chart__range-button" data-range="1w">שבוע</button>
                            <button type="button" class="growth-chart__range-button is-active" data-range="1m">חודש</button>
                            <button type="button" class="growth-chart__range-button" data-range="3m">3 חודשים</button>
                            <button type="button" class="growth-chart__range-button" data-range="1y">שנה</button>
                        </div>
                        <canvas id="growthChart" aria-label="גרף מגמת פעילות"></canvas>
                    </div>
                </section>
                <section class="growth-dashboard__section is-hidden" data-pane="activity">
                    <div class="growth-activity" id="growthActivity"></div>
                </section>
                <section class="growth-dashboard__section is-hidden" data-pane="leaders">
                    <div class="growth-leaders" id="growthLeaders"></div>
                </section>
            </div>
            <footer class="growth-dashboard__footer">
                <div class="growth-dashboard__status" id="growthStatus">מתחבר למדד...</div>
                <div class="growth-dashboard__actions">
                    <label class="growth-dashboard__toggle">
                        <input type="checkbox" id="growthAutoRefresh">
                        <span>רענון אוטומטי</span>
                    </label>
                    <button class="growth-dashboard__refresh" type="button" onclick="refreshGrowthDashboard()">
                        <i class="fa-solid fa-rotate"></i>
                        רענן כעת
                    </button>
                </div>
            </footer>
        </article>
    </section>

    <!-- חלק חוזה חכם V2 (storage.html) – תצוגת השקעה גרפית כמו בפיד | HYPER CORE TECH -->
    <section class="contract-dashboard-v2" id="contractDashboardV2" aria-hidden="true">
        <div class="contract-dashboard-v2__backdrop" onclick="closeContractDashboardV2()"></div>
        <article class="contract-dashboard-v2__panel" role="dialog" aria-modal="true">
            <header class="top-bar top-bar--profile contract-dashboard-v2__header-bar">
                <div class="top-bar__actions top-bar__actions--profile">
                    <button class="circle-button top-bar__refresh" id="contractV2RefreshButton" type="button" aria-label="רענון נתוני החוזה">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>
                <div class="top-bar__title">
                    <span class="top-bar__title-inner">
                        <i class="fa-solid fa-signal" aria-hidden="true"></i>
                        <span>חוזה חכם – SPEAR ONE</span>
                    </span>
                    <p class="top-bar__subtitle">השקעה בטכנולוגיה המבוזרת שמשנה את האינטרנט</p>
                </div>
                <div class="top-bar__actions top-bar__actions--profile">
                    <button class="circle-button top-bar__home" type="button" onclick="closeContractDashboardV2()" aria-label="סגירת חוזה חכם">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </header>
            <div class="contract-dashboard-v2__body">
                <section class="contract-v2-hero" id="contractV2Hero">
                    <div class="contract-v2-hero__copy">
                        <h3>טכנולוגיה חדשנית להחזקה ותפעול של פלטפורמות אינטרנטיות ללא שרת מרכזי ועלויות תשתית.</h3>
                        <p>SPEAR ONE היא תשתית אחת שמפעילה גם רשת חברתית מבוזרת וגם שכבת שרת סטטית – הדגמה חיה לסטארט-אפ שבונה רשתות שמחזירות את השליטה למשתמש.</p>
                        <div class="contract-v2-hero__highlights" id="contractV2Highlights"></div>
                        <div class="contract-v2-hero__actions">
                            <button class="contract-v2-hero__cta" type="button" onclick="openOptionPurchase()">
                                <i class="fa-solid fa-hand-holding-dollar"></i>
                                רכישת יחידה ב-$50
                            </button>
                            <button class="contract-v2-hero__details" type="button" id="contractV2DetailsToggle">
                                <i class="fa-solid fa-circle-info"></i>
                                פרטים נוספים
                            </button>
                            <button class="contract-v2-hero__details" type="button" data-scroll-target="contractV2Calculator">
                                <i class="fa-solid fa-calculator"></i>
                                פתיחת מחשבון השקעה
                            </button>
                        </div>
                    </div>
                    <aside class="contract-v2-hero__glass">
                        <div class="contract-v2-glass__metric">
                            <span class="contract-v2-glass__label">שווי פיתוח מצטבר</span>
                            <span class="contract-v2-glass__value" id="contractV2DevelopmentValue">₪300,000</span>
                        </div>
                        <div class="contract-v2-glass__metric">
                            <span class="contract-v2-glass__label">שווי יחידה משוער</span>
                            <span class="contract-v2-glass__value" id="contractV2UnitValue">--</span>
                        </div>
                        <div class="contract-v2-glass__metric">
                            <span class="contract-v2-glass__label">תשואת פעילות רשת</span>
                            <span class="contract-v2-glass__value" id="contractV2NetworkYield">--</span>
                        </div>
                    </aside>
                </section>
                <section class="contract-v2-chart">
                    <header class="contract-v2-chart__header">
                        <h3>ערך הנכס מול מדד פעילות הרשת</h3>
                        <p>הגרף מוצג בזמן אמת וממחיש כיצד גידול בפעילות, משתמשים וקרדיטים מעלה את ערך SPEAR ONE.</p>
                    </header>
                    <div class="contract-v2-chart__canvas">
                        <canvas id="contractV2Chart" aria-label="גרף נכס מול פעילות"></canvas>
                    </div>
                    <footer class="contract-v2-chart__legend" id="contractV2Legend"></footer>
                </section>
                <section class="contract-v2-infra">
                    <h3>התשתית שמחזיקה את SPEAR ONE</h3>
                    <div class="contract-v2-infra__grid" id="contractV2InfraGrid"></div>
                </section>
                <section class="contract-v2-narrative">
                    <h3>למה להצטרף עכשיו?</h3>
                    <ul class="contract-v2-narrative__list">
                        <li>דמיינו שהייתם משקיעים $50 בביטקוין לפני עשור – כך נראית נקודת פתיחה מוקדמת.</li>
                        <li>רשת חברתית שבה אתם הבעלים, לא המוצר – כל פוסט, Boost ומעורבות מחזירים ערך ישירות אליכם.</li>
                        <li>פרטיות מלאה ושליטה בנתונים: המידע שלכם נשאר אצלכם, ויחידות הערך מגובות בפעילות מוכחת.</li>
                    </ul>
                </section>
                <section class="contract-v2-details" id="contractV2Details" hidden>
                    <h3>פירוט אנליטי</h3>
                    <div class="contract-v2-details__grid">
                        <article>
                            <h4>חיבור לגרף לוח גידול הרשת</h4>
                            <p>הערך הווירטואלי מחושב על בסיס מדד הפעילות (אירועים, לייקים ותגובות) המגיע מהגרף הראשי של לוח הגידול. כל עדכון פעילות מעלה או מוריד את שווי הנכס באופן שקוף.</p>
                        </article>
                        <article>
                            <h4>R&D מושקע ומינוף משתמשים</h4>
                            <p>הושקעו מעל 300,000 ₪ בפיתוח SPEAR ONE – ערך הבסיס. כל משתמש פעיל, אינטגרציה או Relay חדש משכפל את הערך באמצעות תרחישים פיננסיים קונסרבטיביים.</p>
                        </article>
                        <article>
                            <h4>מודל Units ו-Credits</h4>
                            <p>Units נרכשים ב-$50 ומציגים ערך דינמי. Buyback מעניק עד 80% מהערך ב-Credits פנימיים לשימוש בקידום, שירותים והעברות בתוך המערכת – ללא רגולציה חיצונית.</p>
                        </article>
                    </div>
                </section>
                <section class="contract-v2-terms" id="contractV2Terms">
                    <h3>תנאי החוזה</h3>
                    <ol class="contract-v2-terms__list" id="contractV2TermsList"></ol>
                </section>
                <section class="contract-v2-forecast" id="contractV2Forecast">
                    <header class="contract-v2-forecast__header">
                        <div>
                            <h3>תחזית צמיחה לשנה קדימה</h3>
                            <p>תרחישים מבוססי פעילות Relay, משתמשים פעילים ושותפויות עתידיות.</p>
                        </div>
                        <div class="contract-v2-forecast__legend" id="contractV2ForecastLegend"></div>
                    </header>
                    <div class="contract-v2-forecast__chart">
                        <canvas id="contractV2ForecastChart" aria-label="גרף תחזית פעילות ושווי"></canvas>
                    </div>
                    <footer class="contract-v2-forecast__notes" id="contractV2ForecastNotes"></footer>
                </section>
                <section class="contract-v2-calculator" id="contractV2Calculator">
                    <header class="contract-v2-calculator__header">
                        <h3>מחשבון השקעה מיידי</h3>
                        <p>הזינו סכום ובדקו את אחוז הזכות בטכנולוגיה ואת Buyback המשוער.</p>
                    </header>
                    <div class="contract-v2-calculator__body">
                        <label class="contract-v2-calculator__label" for="contractV2InvestmentInput">
                            סכום השקעה בדולר (מינימום $50)
                        </label>
                        <div class="contract-v2-calculator__input">
                            <span class="contract-v2-calculator__currency">$</span>
                            <input type="number" id="contractV2InvestmentInput" min="50" step="50" value="50" />
                        </div>
                        <div class="contract-v2-calculator__summary" id="contractV2CalculatorSummary">
                            <div class="contract-v2-calculator__item">
                                <span class="contract-v2-calculator__item-label">אחוז בטכנולוגיה</span>
                                <strong class="contract-v2-calculator__item-value" id="contractV2Ownership">0%</strong>
                            </div>
                            <div class="contract-v2-calculator__item">
                                <span class="contract-v2-calculator__item-label">Buyback בקרדיטים</span>
                                <strong class="contract-v2-calculator__item-value" id="contractV2Buyback">$0</strong>
                            </div>
                            <div class="contract-v2-calculator__item">
                                <span class="contract-v2-calculator__item-label">קיבולת משתמשים נתמכת</span>
                                <strong class="contract-v2-calculator__item-value" id="contractV2CapacityImpact">0</strong>
                            </div>
                        </div>
                        <button class="contract-v2-calculator__cta" type="button" onclick="openOptionPurchase()">
                            <i class="fa-solid fa-arrow-right-to-bracket"></i>
                            המשך לתהליך ההשקעה
                        </button>
                    </div>
                </section>
            </div>
            <footer class="contract-dashboard-v2__footer">
                <span class="contract-dashboard-v2__status" id="contractV2Status">ממתין לנתוני רשת...</span>
                <button class="contract-dashboard-v2__cta" type="button" onclick="openOptionPurchase()">
                    <i class="fa-solid fa-rocket"></i>
                    הצטרפות עם יחידה אחת
                </button>
            </footer>
        </article>
    </section>

    <!-- חלק אחסון (storage.html) – טעינת ספריות לנוסטר, ניהול מפתחות ודחיסת וידאו | HYPER CORE TECH -->
    <script src="https://cdn.jsdelivr.net/npm/nostr-tools@2.7.2/lib/nostr.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js" defer></script>
    <script src="./config.js" defer></script>
    <script src="./key-utils.js" defer></script>
    <script src="./utils.js" defer></script>
    <script src="./secure-channel.js" defer></script>
    <script src="./keys.js" defer></script>
    <script src="./blossom.js" defer></script>
    <script src="./video-compressor.js" defer></script>
    <script src="./storage/config.js" defer></script>
    <script src="./storage/storage.js" defer></script>
    <!-- חלק ניווט משותף (storage.html) – טעינת לוגיקת ניווט ותפריט פרופיל כמו בפיד | HYPER CORE TECH -->
    <script>
      // קובע לשונית פעילה לפני שהניווט נטען, כדי למנוע מצב ברירת מחדל שגוי
      (function(){
        var App = window.NostrApp || (window.NostrApp = {});
        App.activeNav = 'storage';
      })();
    </script>
    <script src="./navigation.js" defer></script>
    <!-- חלק פרופיל (storage.html) – טעינת מודולי פרופיל כדי ששמות ותמונות יוצגו בצ'אט | HYPER CORE TECH -->
    <script src="./profile.js" defer></script>
    <script>
      // מרנדר את הפרופיל ומושך מטאדאטה אחרי שכל הסקריפטים הdefer נטענו (load)
      window.addEventListener('load', function(){
        var App = window.NostrApp || (window.NostrApp = {});
        try { if (typeof App.renderProfile === 'function') App.renderProfile(); } catch(e) {}
        try { if (typeof App.loadOwnProfileMetadata === 'function') App.loadOwnProfileMetadata(); } catch(e) {}
        try { if (typeof App.subscribeOwnProfileMetadata === 'function') App.subscribeOwnProfileMetadata(); } catch(e) {}
      });
    </script>
    <!-- חלק תמונות/מדיה (storage.html) – מטמון ומראות לעיבוד תמונות אווטאר וקישורי מדיה כמו בפיד | HYPER CORE TECH -->
    <script src="./media-cache.js" defer></script>
    <script src="./media-mirror.js" defer></script>
    <script src="./media-recheck.js" defer></script>
    <!-- חלק רשת עוקבים (storage.html) – שירות שמסייע בפתרון שמות/אווטארים | HYPER CORE TECH -->
    <script src="./follow-service.js" defer></script>
    <!-- חלק פיד (storage.html) – מודול ניהול התראות ופוסטים, נדרש לתצוגת התראות בחלונית | HYPER CORE TECH -->
    <script src="./feed.js" defer></script>
    <!-- חלק גרפים (storage.html) – טעינת Chart.js לגרפים בלוח גידול וחוזה חכם | HYPER CORE TECH -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.min.js"></script>
    <!-- חלק צ'אט (storage.html) – טעינת מודולי הצ'אט כמו בפיד כדי שכפתורי ההתראות/הודעות יעבדו זהה | HYPER CORE TECH -->
    <script src="./chat-state.js" defer></script>
    <script src="./chat-service.js" defer></script>
    <script src="./chat-file-transfer-state.js" defer></script>
    <script src="./chat-file-transfer-service.js" defer></script>
    <script src="./chat-file-transfer-ui.js" defer></script>
    <script src="./chat-voice-service.js" defer></script>
    <script src="./chat-voice-ui.js" defer></script>
    <script src="./chat-voice-call.js" defer></script>
    <script src="./chat-voice-call-ui.js" defer></script>
    <script src="./chat-video-call.js" defer></script>
    <script src="./chat-video-call-ui.js" defer></script>
    <script src="./chat-ui.js" defer></script>
    <!-- לבסוף כמו בפיד: אתחול האפליקציה לאחר שכל המודולים קיימים -->
    <script src="./app.js" defer></script>
    <!-- תפעול תפריט פרופיל בדף אחסון – קריאה ישירה לפונקציות כמו בפיד | HYPER CORE TECH -->
    <script src="./account.js" defer></script>
    <script src="./key-viewer.js" defer></script>
    <script src="./market-dashboard.js" defer></script>
    <script src="./contract-dashboard-v2.js" defer></script>
    <script>
      function initProfileMenuActions(){
        var App = window.NostrApp || window.App || {};
        var growth = document.getElementById('topBarProfileGrowth');
        var key = document.getElementById('topBarProfileKey');
        var contract = document.getElementById('topBarProfileContract');
        
        // אתחול מודולים כדי שהפונקציות יהיו זמינות | HYPER CORE TECH
        if (typeof App.initializeGrowthDashboard === 'function') {
          try { App.initializeGrowthDashboard(); } catch(e) {}
        }
        
        // וודא שה-growthSelectors מעודכן עם ה-DOM של storage.html | HYPER CORE TECH
        if (typeof App.refreshGrowthSelectors === 'function') {
          try { App.refreshGrowthSelectors(); } catch(e) {}
        }
        
        if (growth) {
          growth.addEventListener('click', function(ev){
            ev.preventDefault(); ev.stopPropagation();
            console.log('[STORAGE] Growth button clicked, App.openGrowthDashboard:', typeof App?.openGrowthDashboard);
            if (typeof App?.openGrowthDashboard === 'function') {
              App.openGrowthDashboard();
            } else if (typeof window.openGrowthDashboard === 'function') {
              window.openGrowthDashboard();
            }
            // וודא שה-is-open class נוסף
            var dashboard = document.getElementById('growthDashboard');
            console.log('[STORAGE] Dashboard element:', dashboard, 'has is-open:', dashboard?.classList.contains('is-open'));
          });
        }
        
        if (key) {
          key.addEventListener('click', function(ev){
            ev.preventDefault(); ev.stopPropagation();
            if (typeof App?.openKeyViewer === 'function') {
              App.openKeyViewer();
            } else if (typeof window.openKeyViewer === 'function') {
              window.openKeyViewer();
            }
          });
        }
        
        if (contract) {
          contract.addEventListener('click', function(ev){
            ev.preventDefault(); ev.stopPropagation();
            if (typeof App?.openContractDashboardV2 === 'function') {
              App.openContractDashboardV2();
            } else if (typeof window.openContractDashboardV2 === 'function') {
              window.openContractDashboardV2();
            }
          });
        }
      }
      // קרא כשה-DOM מוכן
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initProfileMenuActions);
      } else {
        initProfileMenuActions();
      }
      window.addEventListener('load', initProfileMenuActions);
    </script>
    <!-- קישור פעמון ההתראות למצב ההתראות של הצ'אט + סנכרון מונה לבאדג' העליון | HYPER CORE TECH -->
    <script>
      function initNotificationsUI(){
        var bell = document.getElementById('notificationsToggle');
        var topBadge = document.getElementById('notificationsBadge');
        var chatBtn = document.getElementById('messagesToggle');

        function clickNotificationsTabWhenReady(attempts){
          var notifTab = document.querySelector('#chatPanelFooter [data-chat-nav="notifications"]');
          if (notifTab) { notifTab.click(); return; }
          if ((attempts||0) > 10) return;
          setTimeout(function(){ clickNotificationsTabWhenReady((attempts||0)+1); }, 120);
        }

        function openNotificationsPane(){
          try {
            if (chatBtn) chatBtn.click();
            clickNotificationsTabWhenReady(0);
          } catch(e) {}
        }

        // סנכרון מונה ההתראות לבאדג' העליון
        function setTopBadge(count){
          var n = Number(count)||0;
          if (!topBadge) return;
          if (n>0){ topBadge.textContent = n>99 ? '99+' : String(n); topBadge.removeAttribute('hidden'); }
          else { topBadge.setAttribute('hidden',''); }
        }
        function recalcFromSnapshot(){
          try{
            if (typeof NostrApp?.getNotificationsSnapshot === 'function'){
              var list = NostrApp.getNotificationsSnapshot()||[];
              var unread = list.reduce((t, x)=> t + (!x?.read ? 1 : 0), 0);
              setTopBadge(unread);
            }
          }catch(e){}
        }
        // הרשמה לשינויים אם קיימת פונקציה ייעודית
        try{
          if (typeof NostrApp?.subscribeNotifications === 'function'){
            NostrApp.subscribeNotifications(function(snapshot){
              var unread = Array.isArray(snapshot) ? snapshot.reduce((t,x)=>t+(!x?.read?1:0),0) : 0;
              setTopBadge(unread);
            });
          }
        }catch(e){}
        // סטטוס התחלתי
        recalcFromSnapshot();

        // קישור פעמון ההתראות לפתיחת חלונית ההתראות הנפרדת – זהה לפיד | HYPER CORE TECH
        var notifPanel = document.getElementById('notificationsPanel');
        var notifList = document.getElementById('notificationsList');
        var notifEmpty = document.getElementById('notificationsEmpty');
        var notifMarkBtn = document.getElementById('notificationsMarkRead');
        
        function positionNotifPanel(){
          if (!notifPanel || !bell) return;
          var r = bell.getBoundingClientRect();
          var w = notifPanel.offsetWidth || 320;
          var vw = window.innerWidth || document.documentElement.clientWidth;
          var left = Math.max(8, Math.min(r.left + r.width/2 - w/2, vw - w - 8));
          notifPanel.style.left = left + 'px';
          notifPanel.style.top = (r.bottom + 8) + 'px';
        }
        
        // פורמט זמן זהה ל-feed.js – מציג יחסי (1m, 5h, 3d) או תאריך מלא | HYPER CORE TECH
        function formatTimestamp(ts){
          if (!ts || typeof ts !== 'number') return '';
          var now = Date.now();
          var diffMs = now - ts;
          var diffSec = Math.floor(diffMs / 1000);
          var diffMin = Math.floor(diffSec / 60);
          var diffHr = Math.floor(diffMin / 60);
          var diffDay = Math.floor(diffHr / 24);
          if (diffMin < 1) return '1m';
          if (diffHr < 1) return diffMin + 'm';
          if (diffDay < 1) return diffHr + 'h';
          if (diffDay < 7) return diffDay + 'd';
          var d = new Date(ts);
          var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          var month = months[d.getMonth()];
          var day = d.getDate();
          var y = d.getFullYear();
          var currentYear = new Date().getFullYear();
          return y === currentYear ? month + ' ' + day : month + ' ' + day + ', ' + y;
        }
        
        function renderNotifList(notifications){
          console.log('[STORAGE] renderNotifList called with', notifications?.length || 0, 'notifications');
          if (!notifList || !notifEmpty) return;
          var items = Array.isArray(notifications) ? notifications : [];
          if (!items.length){
            notifEmpty.removeAttribute('hidden');
            notifList.innerHTML = '';
            return;
          }
          notifEmpty.setAttribute('hidden','');
          var html = items.map(function(n){
            var name = (n?.actorProfile?.name) || (n?.actorPubkey?.slice?.(0,8)) || 'משתמש';
            var initials = (n?.actorProfile?.initials) || (window.NostrApp?.getInitials ? NostrApp.getInitials(name) : 'מש');
            var avatarHtml = n?.actorProfile?.picture
              ? '<img src="'+n.actorProfile.picture+'" alt="'+name+'" referrerpolicy="no-referrer" onerror="this.parentElement && (this.parentElement.innerHTML=\'<span>'+initials+'</span>\');">'
              : '<span>'+initials+'</span>';
            var actionText = n?.type === 'comment' ? 'הגיב לפוסט שלך' : (n?.type === 'dating-like' ? 'הראה עניין בך' : (n?.type === 'follow' ? 'התחיל לעקוב' : 'אהב את הפוסט שלך'));
            var timeLabel = n?.createdAt ? formatTimestamp(n.createdAt * 1000) : '';
            var timeHtml = timeLabel ? '<time class="notifications-item__time">'+timeLabel+'</time>' : '';
            var unreadClass = n?.read ? '' : ' notifications-item--unread';
            var postId = n?.postId ? ' data-post-id="'+n.postId+'"' : '';
            var notifId = n?.id ? ' data-notification-id="'+n.id+'"' : '';
            return '<li class="notifications-item'+unreadClass+'"'+postId+notifId+'><div class="notifications-item__avatar">'+avatarHtml+'</div><div class="notifications-item__content"><span class="notifications-item__actor">'+name+'</span><span class="notifications-item__action">'+actionText+'</span>'+timeHtml+'</div></li>';
          });
          notifList.innerHTML = html.join('');
          // קישור לחיצות על פריטים
          Array.from(notifList.querySelectorAll('li')).forEach(function(li){
            li.addEventListener('click', function(){
              var postId = li.getAttribute('data-post-id');
              var notifId = li.getAttribute('data-notification-id');
              if (postId){
                var target = document.querySelector('[data-post-id="'+postId+'"]');
                if (target){ target.scrollIntoView({behavior:'smooth', block:'center'}); }
              }
              if (notifId && typeof NostrApp?.markNotificationRead === 'function'){
                NostrApp.markNotificationRead(notifId);
              }
            });
          });
        }
        
        function closeNotifPanel(){
          if (notifPanel && !notifPanel.hasAttribute('hidden')){
            notifPanel.setAttribute('hidden','');
            document.removeEventListener('click', outsideListener, true);
            window.removeEventListener('resize', positionNotifPanel);
          }
        }
        
        var outsideListener = function(e){
          if (notifPanel && !notifPanel.contains(e.target) && !bell.contains(e.target)){
            closeNotifPanel();
          }
        };
        
        if (bell && notifPanel){
          console.log('[STORAGE] Notifications bell bound successfully');
          bell.addEventListener('click', function(ev){
            console.log('[STORAGE] Bell clicked, isHidden=', notifPanel.hasAttribute('hidden'));
            ev.stopPropagation();
            var isHidden = notifPanel.hasAttribute('hidden');
            if (isHidden){
              if (typeof NostrApp?.closeChatPanel === 'function') NostrApp.closeChatPanel();
              // טען רשימת צ'אט מהתראות כדי שיהיו אנשי קשר זמינים
              if (typeof NostrApp?.bootstrapChatContacts === 'function') NostrApp.bootstrapChatContacts();
              var list = (typeof NostrApp?.getNotificationsSnapshot === 'function') ? (NostrApp.getNotificationsSnapshot()||[]) : [];
              console.log('[STORAGE] Notifications list:', list);
              renderNotifList(list);
              notifPanel.removeAttribute('hidden');
              positionNotifPanel();
              window.addEventListener('resize', positionNotifPanel);
              if (typeof NostrApp?.markAllNotificationsRead === 'function') NostrApp.markAllNotificationsRead();
              document.addEventListener('click', outsideListener, true);
            } else {
              closeNotifPanel();
            }
          });
          window.addEventListener('resize', function(){ if (!notifPanel.hasAttribute('hidden')) positionNotifPanel(); });
          document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeNotifPanel(); });
        } else {
          console.log('[STORAGE] Notifications bell NOT bound - bell:', !!bell, 'notifPanel:', !!notifPanel);
        }
        
        if (notifMarkBtn){
          notifMarkBtn.addEventListener('click', function(e){
            e.preventDefault();
            if (typeof NostrApp?.markAllNotificationsRead === 'function') NostrApp.markAllNotificationsRead(true);
          });
        }
        
        // הרשמה לעדכונים של התראות
        try{
          if (typeof NostrApp?.subscribeNotifications === 'function'){
            NostrApp.subscribeNotifications(function(snapshot){
              console.log('[STORAGE] Notifications update received:', snapshot?.length || 0);
              renderNotifList(snapshot||[]);
            });
          }
        }catch(e){}
        
        // אתחול התראות: שחזור מ-localStorage ואתחול UI | HYPER CORE TECH
        setTimeout(function(){
          try {
            console.log('[STORAGE] Initializing notifications system');
            // שחזור התראות מ-localStorage אם יש מפתח ציבורי
            if (typeof NostrApp?.publicKey === 'string' && NostrApp.publicKey && !NostrApp.notificationsRestored) {
              console.log('[STORAGE] Restoring notifications from localStorage');
              if (typeof NostrApp.restoreNotificationsFromStorage === 'function') {
                NostrApp.restoreNotificationsFromStorage();
                NostrApp.notificationsRestored = true;
              }
            }
            // אתחול UI של התראות מ-feed.js
            if (typeof NostrApp?.setupNotificationUI === 'function') {
              console.log('[STORAGE] Calling setupNotificationUI');
              NostrApp.setupNotificationUI();
            }
            // רענון מונה
            recalcFromSnapshot();
          } catch(e) {
            console.warn('[STORAGE] Notification setup error:', e);
          }
        }, 200);
        
        // טעינת רשימת צ'אט כשמשתמש פותח את חלון ההודעות | HYPER CORE TECH
        if (chatBtn){
          var originalChatClick = chatBtn.onclick;
          chatBtn.addEventListener('click', function(){
            setTimeout(function(){
              if (typeof NostrApp?.bootstrapChatContacts === 'function') NostrApp.bootstrapChatContacts();
            }, 100);
          });
        }
      }
      // קרא לפונקציה מיד כשה-DOM מוכן
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotificationsUI);
      } else {
        initNotificationsUI();
      }
      // וגם כשחלון הטעינה מסתיים
      window.addEventListener('load', initNotificationsUI);
    </script>
  </body>
</html>
